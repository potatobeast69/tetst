name: üî® Build Check

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.swift'
      - 'Package.swift'
      - 'Package.resolved'
      - '**.xcodeproj/**'
      - '**.xcworkspace/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.swift'
      - 'Package.swift'
      - 'Package.resolved'
      - '**.xcodeproj/**'
      - '**.xcworkspace/**'
  workflow_dispatch:

jobs:
  check-swift-project:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –ø—Ä–æ–µ–∫—Ç–∞
    runs-on: ubuntu-latest
    outputs:
      is-swift: ${{ steps.detect.outputs.is-swift }}
    steps:
      - name: üì• Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
      
      - name: üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø—Ä–æ–µ–∫—Ç–∞
        id: detect
        run: |
          if [ -f "Package.swift" ] || [ -n "$(find . -name '*.swift' -type f | head -n 1)" ]; then
            echo "‚úÖ Swift –ø—Ä–æ–µ–∫—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω"
            echo "is-swift=true" >> $GITHUB_OUTPUT
          else
            echo "‚ÑπÔ∏è  Swift —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–º–ø–∏–ª—è—Ü–∏–∏"
            echo "is-swift=false" >> $GITHUB_OUTPUT
          fi

  build-check:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
    needs: check-swift-project
    if: needs.check-swift-project.outputs.is-swift == 'true'
    runs-on: macos-latest
    timeout-minutes: 20
    
    steps:
      - name: üì• Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
      
      - name: üíæ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ SPM –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-
      
      - name: üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ä–µ–¥–µ
        run: |
          echo "Xcode –≤–µ—Ä—Å–∏—è:"
          xcodebuild -version
          echo ""
          echo "Swift –≤–µ—Ä—Å–∏—è:"
          swift --version
          echo ""
          echo "macOS –≤–µ—Ä—Å–∏—è:"
          sw_vers

      - name: üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
        run: |
          if [ -f "Package.swift" ]; then
            echo "üì¶ –ù–∞–π–¥–µ–Ω Swift Package"
            swift build
          
          elif ls *.xcworkspace >/dev/null 2>&1; then
            WORKSPACE=$(ls -d *.xcworkspace | head -n 1)
            echo "üî® –ù–∞–π–¥–µ–Ω workspace: $WORKSPACE"
            
            SCHEME=$(xcodebuild -workspace "$WORKSPACE" -list | grep -A 1 "Schemes:" | tail -n 1 | xargs)
            echo "üìã –°—Ö–µ–º–∞: $SCHEME"
            
            xcodebuild \
              -workspace "$WORKSPACE" \
              -scheme "$SCHEME" \
              -destination "platform=iOS Simulator,name=iPhone 16" \
              -configuration Debug \
              clean build
          
          elif ls *.xcodeproj >/dev/null 2>&1; then
            PROJECT=$(ls -d *.xcodeproj | head -n 1)
            echo "üî® –ù–∞–π–¥–µ–Ω –ø—Ä–æ–µ–∫—Ç: $PROJECT"
            
            SCHEME=$(xcodebuild -project "$PROJECT" -list | grep -A 1 "Schemes:" | tail -n 1 | xargs)
            echo "üìã –°—Ö–µ–º–∞: $SCHEME"
            
            xcodebuild \
              -project "$PROJECT" \
              -scheme "$SCHEME" \
              -destination "platform=iOS Simulator,name=iPhone 16" \
              -configuration Debug \
              clean build
          else
            echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω Package.swift, .xcworkspace –∏–ª–∏ .xcodeproj"
            exit 1
          fi

      - name: ‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞
        if: success()
        run: echo "‚úÖ –ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω!"

      - name: ‚ùå –°–±–æ—Ä–∫–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å
        if: failure()
        run: |
          echo "‚ùå –ü—Ä–æ–µ–∫—Ç –Ω–µ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è!"
          echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—à–∏–±–∫–∏ –≤—ã—à–µ ‚òùÔ∏è"
          exit 1
